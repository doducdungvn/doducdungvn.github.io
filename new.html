<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Cụ Tính Lô Đề Nâng Cao</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Adjust alignment to prevent overflow */
            min-height: 100vh;
            padding: 16px; /* Reduced padding for mobile */
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 24px; /* Slightly reduced padding for mobile */
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 900px; /* Max width for larger screens */
            width: 100%;
            margin-left: auto;
            margin-right: auto; /* Center the container */
        }
        @media (min-width: 768px) { /* Medium screens and up */
            body {
                padding: 20px;
            }
            .container {
                padding: 30px;
            }
        }
        input[type="text"], input[type="number"], textarea {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 15px;
            width: 100%;
            margin-bottom: 15px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
            outline: none;
            border-color: #6366f1; /* Indigo-500 */
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            border-bottom: 2px solid #6366f1;
            padding-bottom: 8px;
        }
        .btn {
            background-color: #6366f1; /* Indigo-500 */
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100%;
            border: none;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }
        .btn:hover {
            background-color: #4f46e5; /* Indigo-600 */
            transform: translateY(-2px);
        }
        .btn:active {
            background-color: #3f36a5; /* Indigo-700 */
            transform: translateY(0);
        }
        .result-box {
            background-color: #f8faff; /* Light blue background */
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #d1d5db; /* Gray-300 */
            margin-top: 25px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #e0e0e0;
            font-weight: 500;
            color: #4b5563; /* Gray-700 */
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .result-value-pair {
            font-weight: 700;
            color: #1f2937; /* Gray-900 */
            text-align: right;
        }
        .result-bet-display { /* New style for bet amount */
            color: #4299e1; /* Blue-500 */
            font-weight: 600;
        }
        .result-cost-display { /* Existing style for actual cost (gốc) */
            color: #f59e0b; /* Amber-500 */
            font-weight: 600;
        }
        .result-winnings-display {
            color: #22c55e; /* Green-500 */
            font-weight: 600;
        }
        .total-summary {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin-top: 15px;
            text-align: center;
        }
        .summary-profit {
            color: #22c55e; /* Green for profit */
        }
        .summary-loss {
            color: #ef4444; /* Red for loss */
        }
        .summary-breakeven {
            color: #4b5563; /* Gray for breakeven */
        }
        .error-message {
            color: #ef4444; /* Red-500 */
            margin-top: -10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        .grid-cols-custom {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }
        @media (max-width: 640px) {
            .grid-cols-custom {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <script>console.log("Script loaded at body start.");</script>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Công Cụ Tính Lô Đề Nâng Cao</h1>
        <p class="text-center text-gray-600 mb-8">Nhập thông tin cược, kết quả xổ số và tính toán! </p>

        <div class="mb-6">
            <h2 class="section-title">Cấu hình tỷ lệ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                <!-- Đề Rates -->
                <div>
                    <label for="deCostPercentage" class="block text-gray-700 text-sm font-bold mb-2">Đề: Tiền gốc (%)</label>
                    <input type="number" id="deCostPercentage" value="82" min="0" max="100" class="w-full">
                </div>
                <div>
                    <label for="dePayoutRate" class="block text-gray-700 text-sm font-bold mb-2">Đề: Thưởng (lần)</label>
                    <input type="number" id="dePayoutRate" value="80" min="0" class="w-full">
                </div>
                <!-- Lô Rates -->
                <div>
                    <label for="loCostPerPoint" class="block text-gray-700 text-sm font-bold mb-2">Lô: Tiền gốc (Giá nhập)</label>
                    <input type="number" id="loCostPerPoint" value="2165" min="0" class="w-full">
                </div>
                <div>
                    <label for="loPayoutRate" class="block text-gray-700 text-sm font-bold mb-2">Lô: Thưởng (lần)</label>
                    <input type="number" id="loPayoutRate" value="80" min="0" class="w-full">
                </div>
                <!-- Xiên Rates -->
                <div>
                    <label for="xienCostPercentage" class="block text-gray-700 text-sm font-bold mb-2">Xiên: Tiền gốc (%)</label>
                    <input type="number" id="xienCostPercentage" value="65" min="0" max="100" class="w-full">
                </div>
                <div>
                    <label for="xien2PayoutRate" class="block text-gray-700 text-sm font-bold mb-2">Xiên 2: Thưởng (lần)</label>
                    <input type="number" id="xien2PayoutRate" value="11" min="0" class="w-full">
                </div>
                <div>
                    <label for="xien3PayoutRate" class="block text-gray-700 text-sm font-bold mb-2">Xiên 3: Thưởng (lần)</label>
                    <input type="number" id="xien3PayoutRate" value="45" min="0" class="w-full">
                </div>
                <div>
                    <label for="xien4PayoutRate" class="block text-gray-700 text-sm font-bold mb-2">Xiên 4: Thưởng (lần)</label>
                    <input type="number" id="xien4PayoutRate" value="140" min="0" class="w-full">
                </div>
                <!-- 3 Càng Rates -->
                <div>
                    <label for="baCangCostPercentage" class="block text-gray-700 text-sm font-bold mb-2">3 Càng: Tiền gốc (%)</label>
                    <input type="number" id="baCangCostPercentage" value="75" min="0" max="100" class="w-full">
                </div>
                <div>
                    <label for="baCangPayoutRate" class="block text-gray-700 text-sm font-bold mb-2">3 Càng: Thưởng (lần)</label>
                    <input type="number" id="baCangPayoutRate" value="400" min="0" class="w-full">
                </div>
                <div>
                    <label for="apMaPayoutRate" class="block text-gray-700 text-sm font-bold mb-2">Áp Má: Thưởng (lần)</label>
                    <input type="number" id="apMaPayoutRate" value="5" min="0" class="w-full">
                </div>
            </div>
        </div>

        <div class="mb-6">
            <h2 class="section-title">Nhập liệu cược</h2>
            <label for="combinedBetInput" class="block text-gray-700 text-sm font-bold mb-2">
                Nhập các lượt cược (mỗi dòng một loại, ví dụ: Đề 23.45.65.676x100)<br>
                Hỗ trợ dấu phân cách số: chấm (.), phẩy (,), gạch ngang (-), khoảng trắng ( )<br>
                Hỗ trợ nhiều cách viết cho loại cược (ví dụ: 'd', 'đề', 'De', 'D', 'de' cho Đề)<br>
                **Ví dụ nhập nhiều lượt cược trên cùng 1 dòng:** `Đề 101.23*10 242.21+10`
            </label>
            <textarea id="combinedBetInput" rows="10" placeholder="Đề 101.23*10 242.21+10&#10;lô 12 34 x5&#10;Xien 55-66*20&#10;3C 123.456*50, 345x50" class="w-full"></textarea>
        </div>

        <div class="mb-6">
            <label for="specialPrize" class="block text-gray-700 text-sm font-bold mb-2">Kết quả Giải Đặc Biệt (ví dụ: 12345):</label>
            <input type="text" id="specialPrize" placeholder="Nhập số cuối Giải Đặc Biệt (ví dụ: 12345)" class="w-full">
            <p class="text-gray-500 text-xs mt-1">Chỉ lấy 2 hoặc 3 số cuối tùy loại hình.</p>
        </div>

        <div class="mb-6">
            <label for="allPrizes" class="block text-gray-700 text-sm font-bold mb-2">Tất cả các giải (ví dụ: 01, 12, 23, 34, ...):</label>
            <input type="text" id="allPrizes" placeholder="Nhập các số cuối của 27 giải, cách nhau bởi dấu phẩy" class="w-full">
            <p class="text-gray-500 text-xs mt-1">Dùng để tính Lô, Xiên. Ví dụ: 01,12,23,45,67,...</p>
        </div>

        <button id="calculateBtn" class="btn">Tính Toán</button>

        <div id="results" class="result-box hidden">
            <h2 class="section-title !border-b-0 text-center">Kết Quả</h2>
            <div id="resultDetails">
                <!-- Results will be displayed here -->
            </div>
            <div id="totalSummary" class="total-summary">
                <!-- Total summary will be displayed here -->
            </div>
        </div>

        <div id="messageBox" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                <h3 class="text-xl font-bold mb-4" id="messageTitle"></h3>
                <p class="text-gray-700 mb-6" id="messageContent"></p>
                <button id="messageCloseBtn" class="btn w-full">Đóng</button>
            </div>
        </div>
    </div>

    <script>
        console.log("Script execution started."); // DEBUG
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded event fired."); // DEBUG
            const combinedBetInput = document.getElementById('combinedBetInput');
            const specialPrizeInput = document.getElementById('specialPrize');
            const allPrizesInput = document.getElementById('allPrizes');
            const calculateBtn = document.getElementById('calculateBtn');
            const resultsDiv = document.getElementById('results');
            const resultDetailsDiv = document.getElementById('resultDetails');
            const totalSummaryDiv = document.getElementById('totalSummary');
            const messageBox = document.getElementById('messageBox');
            const messageTitle = document.getElementById('messageTitle');
            const messageContent = document.getElementById('messageContent');
            const messageCloseBtn = document.getElementById('messageCloseBtn');

            // Input fields for custom rates
            const deCostPercentageInput = document.getElementById('deCostPercentage');
            const dePayoutRateInput = document.getElementById('dePayoutRate');
            const loCostPerPointInput = document.getElementById('loCostPerPoint');
            const loPayoutRateInput = document.getElementById('loPayoutRate');
            const xienCostPercentageInput = document.getElementById('xienCostPercentage');
            const xien2PayoutRateInput = document.getElementById('xien2PayoutRate');
            const xien3PayoutRateInput = document.getElementById('xien3PayoutRate');
            const xien4PayoutRateInput = document.getElementById('xien4PayoutRate');
            const baCangCostPercentageInput = document.getElementById('baCangCostPercentage');
            const baCangPayoutRateInput = document.getElementById('baCangPayoutRate');
            const apMaPayoutRateInput = document.getElementById('apMaPayoutRate');

            let parsedBets = {
                de: [],
                lo: [],
                xien2: [],
                xien3: [],
                xien4: [],
                bacang: []
            };

            // Hàm hiển thị thông báo tùy chỉnh
            function showMessage(title, content) {
                console.log(`Displaying message: ${title} - ${content}`); // DEBUG
                messageTitle.textContent = title;
                messageContent.textContent = content;
                messageBox.classList.remove('hidden');
                resultsDiv.classList.add('hidden'); // Ensure results are hidden if an error occurs
            }

            // Đóng hộp thoại thông báo
            messageCloseBtn.addEventListener('click', () => {
                messageBox.classList.add('hidden');
            });

            // Hàm lấy N số cuối của một chuỗi số
            function getLastNDigits(numberString, n) {
                if (!numberString || numberString.length < n) {
                    return ''; // Return empty string for safety
                }
                return numberString.slice(-n);
            }

            // Hàm kiểm tra xem một số có xuất hiện trong danh sách kết quả lô không
            function isNumberInPrizes(number, prizes) {
                return prizes.includes(number);
            }

            // Hàm tạo tất cả các tổ hợp Xiên từ một mảng số
            function getCombinations(arr, k) {
                const result = [];
                function backtrack(start, currentCombination) {
                    if (currentCombination.length === k) {
                        result.push([...currentCombination]);
                        return;
                    }
                    for (let i = start; i < arr.length; i++) {
                        currentCombination.push(arr[i]);
                        backtrack(i + 1, currentCombination);
                        currentCombination.pop();
                    }
                }
                backtrack(0, []);
                return result;
            }

            // Hàm chuẩn hóa và lấy các số từ chuỗi nhập liệu cho Đề/Lô/Xiên/3C
            // Handles multiple separators (., -, space, comma)
            // Handles 3-digit numbers splitting into two 2-digit numbers (e.g. 101 -> 10, 01)
            // For 3c, also allows multiple 3-digit numbers separated by separators
            function parseNumbersFromBetString(numbersString, betType) {
                const segments = numbersString.split(/[.,\-\s]+/).filter(s => s.length > 0);
                const numbers = []; 

                segments.forEach(seg => {
                    if (!/^\d+$/.test(seg)) { // Ensure segment is purely numeric
                        return; // Skip non-numeric segments
                    }

                    if (betType === 'de' || betType === 'lo') {
                        if (seg.length === 2) {
                            numbers.push(seg);
                        } else if (seg.length === 3) {
                            numbers.push(seg.substring(0, 2)); // e.g., '10' from '101'
                            numbers.push(seg.substring(1, 3)); // e.g., '01' from '101'
                        }
                    } else if (betType === 'xien') {
                        if (seg.length === 2) {
                            numbers.push(seg);
                        }
                    } else if (betType === 'bacang') {
                        if (seg.length === 3) {
                            numbers.push(seg);
                        }
                    }
                });
                return numbers; // Return all parsed numbers
            }

            // Hàm phân tích toàn bộ chuỗi nhập liệu cược
            function parseCombinedInput(inputString) {
                console.log("Starting parseCombinedInput for:", inputString); // DEBUG
                // Reset parsedBets for each calculation
                parsedBets = {
                    de: [],
                    lo: [],
                    xien2: [],
                    xien3: [],
                    xien4: [],
                    bacang: []
                };

                const lines = inputString.split('\n');
                let hasError = false;

                // Regex để khớp với các biến thể của loại hình cược
                const typeRegex = {
                    de: /^(đề|d|de)$/i,
                    lo: /^(lô|l|lo)$/i,
                    xien: /^(xiên|x|xien2|xien3|xien4|x2|x3|x4)$/i, 
                    bacang: /^(3càng|3cang|3c)$/i
                };

                for (let lineIndex = 0; lineIndex < lines.length; lineIndex++) { // Change to for loop for error breaking
                    const line = lines[lineIndex];
                    const trimmedLine = line.trim();
                    if (!trimmedLine) continue; // Bỏ qua dòng trống

                    // Tách loại cược (từ đầu dòng đến khoảng trắng đầu tiên) và phần còn lại của nội dung cược
                    const initialMatch = trimmedLine.match(/^(\S+)\s*(.*)$/); 

                    if (!initialMatch) {
                         showMessage('Lỗi nhập liệu', `Dòng ${lineIndex + 1}: Định dạng không hợp lệ, không tìm thấy loại cược hoặc nội dung cược. Vui lòng nhập đúng cú pháp.`);
                         hasError = true;
                         break; // Break from for loop
                    }

                    const rawBetType = initialMatch[1].toLowerCase().trim(); // Lấy loại cược thô
                    const betContentString = initialMatch[2]; // Phần còn lại của dòng (ví dụ: "101.23*10 242.21+10")
                    console.log(`Line ${lineIndex + 1}: Raw Type: '${rawBetType}', Content: '${betContentString}'`); // DEBUG

                    let normalizedType = '';
                    if (typeRegex.de.test(rawBetType)) {
                        normalizedType = 'de';
                    } else if (typeRegex.lo.test(rawBetType)) {
                        normalizedType = 'lo';
                    } else if (typeRegex.xien.test(rawBetType)) {
                        normalizedType = 'xien';
                    } else if (typeRegex.bacang.test(rawBetType)) {
                        normalizedType = 'bacang';
                    } else {
                        showMessage('Lỗi nhập liệu', `Dòng ${lineIndex + 1}: Loại cược "${rawBetType}" không được hỗ trợ.`);
                        hasError = true;
                        break; // Break from for loop
                    }
                    console.log(`Normalized Type: ${normalizedType}`); // DEBUG
                    
                    // Now, parse the betContentString for multiple bet groups
                    // Each group is: (numbers_string)(operator)(amount)
                    const betGroupSplitRegex = /([0-9.,\-\s]+)([x+*])(\d+)(?:\s*|$)/gi; 
                    let groupMatch;
                    let lineHasValidBets = false;

                    // Ensure previous match state is cleared for global regex
                    betGroupSplitRegex.lastIndex = 0; 

                    while ((groupMatch = betGroupSplitRegex.exec(betContentString)) !== null) {
                        const numbersStringSegment = groupMatch[1].trim(); 
                        const amountValue = parseFloat(groupMatch[3]); 
                        console.log(`  Segment: '${numbersStringSegment}', Amount: ${amountValue}`); // DEBUG

                        if (amountValue <= 0 || isNaN(amountValue)) {
                            showMessage('Lỗi nhập liệu', `Dòng ${lineIndex + 1}: Số tiền/điểm cược (${amountValue}) không hợp lệ.`);
                            hasError = true;
                            break; // Break from while loop
                        }

                        // Parse individual numbers from this segment string
                        const individualNumbersFromSegment = parseNumbersFromBetString(numbersStringSegment, normalizedType);
                        console.log(`    Parsed Individual Numbers:`, individualNumbersFromSegment); // DEBUG

                        // --- Validation of parsed numbers for specific types ---
                        let currentBetIsValid = true;
                        if (individualNumbersFromSegment.length === 0) {
                            showMessage('Lỗi nhập liệu', `Dòng ${lineIndex + 1}: Không tìm thấy số hợp lệ nào trong "${numbersStringSegment}".`);
                            currentBetIsValid = false;
                        } else if (normalizedType === 'bacang') {
                            if (individualNumbersFromSegment.some(n => n.length !== 3)) {
                                showMessage('Lỗi nhập liệu', `Dòng ${lineIndex + 1}: Số 3 Càng (${numbersStringSegment}) không hợp lệ (mỗi số phải là 3 chữ số).`);
                                currentBetIsValid = false;
                            }
                        } else if (normalizedType === 'xien') {
                            if (individualNumbersFromSegment.some(n => n.length !== 2)) {
                                showMessage('Lỗi nhập liệu', `Dòng ${lineIndex + 1}: Số Xiên (${numbersStringSegment}) không hợp lệ (mỗi số phải là 2 chữ số).`);
                                currentBetIsValid = false;
                            } else if (new Set(individualNumbersFromSegment).size !== individualNumbersFromSegment.length) {
                                showMessage('Lỗi nhập liệu', `Dòng ${lineIndex + 1}: Số Xiên (${numbersStringSegment}) có số trùng lặp.`);
                                currentBetIsValid = false;
                            } else if (individualNumbersFromSegment.length < 2 || individualNumbersFromSegment.length > 4) {
                                showMessage('Lỗi nhập liệu', `Dòng ${lineIndex + 1}: Xiên (${numbersStringSegment}) chỉ hỗ trợ 2, 3 hoặc 4 số. ${individualNumbersFromSegment.length} số được tìm thấy.`);
                                currentBetIsValid = false;
                            }
                        } else if (normalizedType === 'de' || normalizedType === 'lo') { 
                            if (individualNumbersFromSegment.some(n => n.length !== 2)) {
                                 showMessage('Lỗi nhập liệu', `Dòng ${lineIndex + 1}: Số ${normalizedType} (${numbersStringSegment}) không hợp lệ (phải là số 2 hoặc 3 chữ số).`);
                                 currentBetIsValid = false;
                            }
                        }

                        if (!currentBetIsValid) {
                            hasError = true;
                            break; // Break from while loop
                        }


                        // Convert amount from 'nghìn đồng' to actual VND for internal calculation (for Đề, Xiên, 3 Càng)
                        // For Lô, amount is already in points.
                        let amountToUseForBet = amountValue; 
                        if (['de', 'xien', 'bacang'].includes(normalizedType)) {
                            amountToUseForBet = amountValue * 1000; // e.g., 10 (nghìn) -> 10,000 VND
                        }
                        console.log(`    Amount for calc: ${amountToUseForBet}`); // DEBUG

                        // Now, push each parsed number/combination to the correct parsedBets array
                        // The amountToUseForBet applies to EACH individual number if de/lo/bacang, or to the whole combination if xien
                        if (normalizedType === 'xien') {
                            if (individualNumbersFromSegment.length >= 2 && individualNumbersFromSegment.length <= 4) {
                                if (individualNumbersFromSegment.length === 2) {
                                    parsedBets.xien2.push({ numbers: individualNumbersFromSegment, amount: amountToUseForBet });
                                } else if (individualNumbersFromSegment.length === 3) {
                                    parsedBets.xien3.push({ numbers: individualNumbersFromSegment, amount: amountToUseForBet });
                                } else if (individualNumbersFromSegment.length === 4) {
                                    parsedBets.xien4.push({ numbers: individualNumbersFromSegment, amount: amountToUseForBet });
                                }
                                lineHasValidBets = true; // Mark valid bet found for this line
                            }
                        } else { // 'de', 'lo', or 'bacang'
                            // For Đề/Lô/3C, each parsed number from the segment string becomes a separate bet
                            if (individualNumbersFromSegment.length > 0) {
                                individualNumbersFromSegment.forEach(singleNum => {
                                    // Pushing the single number as an array element for consistency across all bet types
                                    parsedBets[normalizedType].push({ numbers: [singleNum], amount: amountToUseForBet });
                                });
                                lineHasValidBets = true;
                            }
                        }
                    } // End while loop for bet groups

                    if (hasError) break; // Break from outer for loop if error occurred in inner while loop

                    if (!lineHasValidBets) {
                        showMessage('Lỗi nhập liệu', `Dòng ${lineIndex + 1}: Không tìm thấy lượt cược hợp lệ nào sau loại cược. Vui lòng kiểm tra định dạng số và số tiền.`);
                        hasError = true;
                        break; // Break from outer for loop
                    }
                } // End for loop for lines
                console.log("Finished parseCombinedInput. Parsed Bets:", parsedBets); // DEBUG
                return !hasError;
            }

            // --- Parsing function for values that are interpreted with an implied thousands component ---
            // Applies to Lo cost and ALL payout multipliers (since they represent "X nghìn đồng" or "X lần" multiplier)
            function parseMultiplierOrLoCost(inputValue) {
                const strValue = String(inputValue).trim();
                const num = parseFloat(strValue);

                if (isNaN(num)) {
                    return 0;
                }

                // If input is 2 digits, it's X (e.g., "80" -> 80, "22" -> 22)
                if (strValue.length === 2) {
                    return num;
                } 
                // If input is 4 digits, first 2 are integer thousands, last 2 are decimal thousands (e.g., "2165" -> 21.65)
                else if (strValue.length === 4) {
                    const integerPart = parseFloat(strValue.slice(0, 2)); // e.g., "21"
                    const decimalPart = parseFloat(strValue.slice(2));   // e.g., "65"
                    return integerPart + (decimalPart / 100); // 21 + 65/100 = 21.65
                }
                // For other lengths (1, 3, 5+), treat as direct value
                // e.g., "5" -> 5, "400" -> 400, "80000" -> 80000
                else {
                    return num;
                }
            }


            // --- Calculation Functions ---

            // Hàm tính toán Đề
            function calculateDeWinnings(deBets, specialPrizeLast2, dePayoutRateMultiplier) { 
                let winnings = 0;
                deBets.forEach(bet => {
                    bet.numbers.forEach(num => { 
                        if (num === specialPrizeLast2) {
                            winnings += bet.amount * dePayoutRateMultiplier; 
                        }
                    });
                });
                return winnings;
            }

            // Hàm tính toán chi phí Đề (tiền gốc)
            function calculateDeCost(deBets, deCostPercentage) {
                let cost = 0;
                deBets.forEach(bet => {
                    cost += bet.numbers.length * bet.amount * (deCostPercentage / 100);
                });
                return cost;
            }
            
            // Hàm tính tổng tiền cược Đề (tiền user nhập)
            function calculateDeBetAmount(deBets) {
                let totalBet = 0;
                deBets.forEach(bet => {
                    totalBet += bet.numbers.length * (bet.amount / 1000); // Return in 'nghìn đồng' unit for display
                });
                return totalBet;
            }

            // Hàm tính tiền trúng thô Đề (chưa nhân thưởng)
            function calculateDeRawWinnings(deBets, specialPrizeLast2) {
                let rawWinnings = 0;
                deBets.forEach(bet => {
                    bet.numbers.forEach(num => { 
                        if (num === specialPrizeLast2) {
                            rawWinnings += (bet.amount / 1000); // Return in 'nghìn đồng' unit for display
                        }
                    });
                });
                return rawWinnings;
            }

            // Hàm tính toán Lô
            function calculateLoWinnings(loBets, allPrizesLast2Digits, loPayoutRateMultiplier) { 
                let winnings = 0;
                loBets.forEach(bet => {
                    let matchesForThisBet = 0;
                    bet.numbers.forEach(num => { 
                        allPrizesLast2Digits.forEach(prizeNum => {
                            if (num === prizeNum) {
                                matchesForThisBet++;
                            }
                        });
                    });
                    winnings += matchesForThisBet * bet.amount * loPayoutRateMultiplier * 1000; 
                });
                return winnings;
            }

            // Hàm tính toán chi phí Lô (tiền gốc)
            function calculateLoCost(loBets, loCostPerPointMultiplier) { 
                let cost = 0;
                loBets.forEach(bet => {
                    cost += bet.numbers.length * bet.amount * loCostPerPointMultiplier * 1000; 
                });
                return cost;
            }

            // Hàm tính tổng tiền cược Lô (tổng điểm user nhập)
            function calculateLoBetPoints(loBets) {
                let totalPoints = 0;
                loBets.forEach(bet => {
                    totalPoints += bet.numbers.length * bet.amount;
                });
                return totalPoints;
            }

            // Hàm tính điểm trúng thô Lô (chưa nhân thưởng)
            function calculateLoRawWinnings(loBets, allPrizesLast2Digits) {
                let rawWinnings = 0; // This will be in points
                loBets.forEach(bet => {
                    bet.numbers.forEach(num => { 
                        allPrizesLast2Digits.forEach(prizeNum => {
                            if (num === prizeNum) {
                                rawWinnings += bet.amount; // Add the bet amount (points) for each hit
                            }
                        });
                    });
                });
                return rawWinnings;
            }


            // Hàm tính toán Xiên (2, 3, 4)
            function calculateXienWinnings(xienBets, allPrizesLast2Digits, xienType, payoutRateMultiplier) { 
                let winnings = 0;
                xienBets.forEach(bet => {
                    const allNumbersHit = bet.numbers.every(num => isNumberInPrizes(num, allPrizesLast2Digits));
                    if (allNumbersHit) {
                        winnings += (bet.amount / 1000) * payoutRateMultiplier * 1000; 
                    }
                });
                return winnings;
            }

            // Hàm tính toán chi phí Xiên (tiền gốc, chung cho Xiên 2, 3, 4)
            function calculateXienCost(xienBets, xienCostPercentage) {
                let cost = 0;
                xienBets.forEach(bet => {
                    cost += bet.numbers.length * bet.amount * (xienCostPercentage / 100); 
                });
                return cost;
            }

            // Hàm tính tổng tiền cược Xiên (tiền user nhập)
            function calculateXienBetAmount(xienBets) {
                let totalBet = 0;
                xienBets.forEach(bet => {
                    totalBet += (bet.amount / 1000); // Return in 'nghìn đồng' unit for display
                });
                return totalBet;
            }

            // Hàm tính toán 3 Càng
            function calculate3CangWinnings(bacangBets, specialPrizeLast3, specialPrizeLast2, baCangPayoutRateMultiplier, apMaPayoutRateMultiplier) { 
                let winnings = 0;
                bacangBets.forEach(bet => {
                    if (bet.numbers[0] === specialPrizeLast3) { // Access the single number from the numbers array
                        winnings += (bet.amount / 1000) * baCangPayoutRateMultiplier * 1000;
                    } else if (bet.numbers[0].slice(-2) === specialPrizeLast2) { // Access the single number from the numbers array
                        winnings += (bet.amount / 1000) * apMaPayoutRateMultiplier * 1000;
                    }
                });
                return winnings;
            }

            // Hàm tính toán chi phí 3 Càng (tiền gốc)
            function calculate3CangCost(bacangBets, baCangCostPercentage) {
                let cost = 0;
                bacangBets.forEach(bet => {
                    cost += bet.numbers.length * bet.amount * (baCangCostPercentage / 100);
                });
                return cost;
            }

            // Hàm tính tổng tiền cược 3 Càng (tiền user nhập)
            function calculate3CangBetAmount(bacangBets) {
                let totalBet = 0;
                bacangBets.forEach(bet => {
                    totalBet += (bet.amount / 1000); // Return in 'nghìn đồng' unit for display
                });
                return totalBet;
            }

            // Hàm định dạng tiền tệ hiển thị ở dạng "nghìn đồng" với 3 chữ số thập phân
            const formatMoneyInThousandsDisplay = (valueInVND) => {
                const valueInThousands = valueInVND / 1000;
                // Use minimumFractionDigits: 0 to allow integers to be displayed without decimals
                // Use maximumFractionDigits: 3 to handle cases like 216.5 -> 216,500
                return valueInThousands.toLocaleString('vi-VN', { minimumFractionDigits: 0, maximumFractionDigits: 3 });
            };


            calculateBtn.addEventListener('click', () => {
                console.log("Calculate button clicked."); // DEBUG
                try { // Added try-catch block for overall error handling
                    const specialPrizeFull = specialPrizeInput.value.trim();
                    const allPrizesFull = allPrizesInput.value.trim();
                    console.log("Special Prize Full:", specialPrizeFull); // DEBUG
                    console.log("All Prizes Full:", allPrizesFull); // DEBUG

                    // Lấy các tỷ lệ từ ô input và áp dụng hàm parseMultiplierOrLoCost cho các trường hợp cần thiết
                    const deCostPercentage = parseFloat(deCostPercentageInput.value); 
                    const dePayoutRate = parseMultiplierOrLoCost(dePayoutRateInput.value);
                    console.log("Rates - De Cost %:", deCostPercentage, "De Payout:", dePayoutRate); // DEBUG

                    const loCostPerPoint = parseMultiplierOrLoCost(loCostPerPointInput.value); // Lô tiền gốc: dùng logic đặc biệt
                    const loPayoutRate = parseMultiplierOrLoCost(loPayoutRateInput.value); // Lô thưởng: dùng logic đặc biệt
                    console.log("Rates - Lo Cost:", loCostPerPoint, "Lo Payout:", loPayoutRate); // DEBUG
                    
                    const xienCostPercentage = parseFloat(xienCostPercentageInput.value);
                    const xien2PayoutRate = parseMultiplierOrLoCost(xien2PayoutRateInput.value); 
                    const xien3PayoutRate = parseMultiplierOrLoCost(xien3PayoutRateInput.value); 
                    const xien4PayoutRate = parseMultiplierOrLoCost(xien4PayoutRateInput.value); 
                    console.log("Rates - Xien Cost %:", xienCostPercentage, "Xien2:", xien2PayoutRate, "Xien3:", xien3PayoutRate, "Xien4:", xien4PayoutRate); // DEBUG
                    
                    const baCangCostPercentage = parseFloat(baCangCostPercentageInput.value); 
                    const baCangPayoutRate = parseMultiplierOrLoCost(baCangPayoutRateInput.value); 
                    const apMaPayoutRate = parseMultiplierOrLoCost(apMaPayoutRateInput.value); 
                    console.log("Rates - 3Cang Cost %:", baCangCostPercentage, "3Cang Payout:", baCangPayoutRate, "ApMa:", apMaPayoutRate); // DEBUG

                    // Validation for rates
                    if (isNaN(deCostPercentage) || isNaN(dePayoutRate) || isNaN(loCostPerPoint) || isNaN(loPayoutRate) ||
                        isNaN(xienCostPercentage) || isNaN(xien2PayoutRate) || isNaN(xien3PayoutRate) || isNaN(xien4PayoutRate) ||
                        isNaN(baCangCostPercentage) || isNaN(baCangPayoutRate) || isNaN(apMaPayoutRate)) {
                        showMessage('Lỗi cấu hình', 'Vui lòng nhập đầy đủ và chính xác các tỷ lệ.');
                        return;
                    }

                    if (!specialPrizeFull) {
                        showMessage('Lỗi nhập liệu', 'Vui lòng nhập kết quả Giải Đặc Biệt.');
                        return;
                    }
                    if (!allPrizesFull) {
                        showMessage('Lỗi nhập liệu', 'Vui lòng nhập kết quả Tất cả các giải.');
                        return;
                    }

                    // Thực hiện phân tích input trước. Nếu có lỗi, parseCombinedInput sẽ gọi showMessage và return false.
                    if (!parseCombinedInput(combinedBetInput.value)) {
                        console.error("Parsing input failed."); // DEBUG
                        return; // Dừng thực thi nếu có lỗi trong parsing
                    }
                    console.log("Input parsed successfully."); // DEBUG

                    // Lấy 2 và 3 số cuối của Giải Đặc Biệt (an toàn với fallback chuỗi rỗng)
                    const specialPrizeLast2 = getLastNDigits(specialPrizeFull, 2); 
                    const specialPrizeLast3 = getLastNDigits(specialPrizeFull, 3);
                    console.log("Special Prize Last 2:", specialPrizeLast2, "Last 3:", specialPrizeLast3); // DEBUG

                    // Chuẩn hóa tất cả các giải về 2 số cuối để tính Lô và Xiên
                    const allPrizesAsNumbers = allPrizesFull.split(/[\s,]+/)
                                                .filter(s => s.length > 0)
                                                .map(s => getLastNDigits(s, 2))
                                                .filter(s => s !== '' && s.length === 2); // Filter out empty or invalid segments
                    console.log("All Prizes as Numbers:", allPrizesAsNumbers); // DEBUG

                    let overallTotalWinnings = 0;
                    let overallTotalCostGoc = 0;
                    let resultsHtml = '';

                    // --- Tính toán và hiển thị kết quả cho Đề ---
                    const winningsDe = calculateDeWinnings(parsedBets.de, specialPrizeLast2, dePayoutRate); 
                    const costDeGoc = calculateDeCost(parsedBets.de, deCostPercentage);
                    const betAmountDe = calculateDeBetAmount(parsedBets.de); // Tiền cược ban đầu (user nhập)
                    const rawWinningsDe = calculateDeRawWinnings(parsedBets.de, specialPrizeLast2); // Tiền trúng thô (chưa nhân thưởng)
                    console.log("De - Winnings:", winningsDe, "Cost Goc:", costDeGoc, "Bet Amount:", betAmountDe, "Raw Winnings:", rawWinningsDe); // DEBUG

                    if (parsedBets.de.length > 0) {
                        resultsHtml += `<div class="result-item">
                                            <span class="result-label">Đề:</span>
                                            <span class="result-value-pair">
                                                <span class="result-bet-display">${Math.round(betAmountDe).toLocaleString('vi-VN')}</span> / 
                                                <span class="result-winnings-display">${Math.round(rawWinningsDe).toLocaleString('vi-VN')}</span>
                                            </span>
                                        </div>`;
                    }
                    overallTotalWinnings += winningsDe;
                    overallTotalCostGoc += costDeGoc;

                    // --- Tính toán và hiển thị kết quả cho Lô ---
                    const winningsLo = calculateLoWinnings(parsedBets.lo, allPrizesAsNumbers, loPayoutRate);
                    const costLoGoc = calculateLoCost(parsedBets.lo, loCostPerPoint); 
                    const betPointsLo = calculateLoBetPoints(parsedBets.lo); // Điểm cược ban đầu (user nhập)
                    const rawWinningsLo = calculateLoRawWinnings(parsedBets.lo, allPrizesAsNumbers); // Điểm trúng thô (chưa nhân thưởng)
                    console.log("Lo - Winnings:", winningsLo, "Cost Goc:", costLoGoc, "Bet Points:", betPointsLo, "Raw Winnings:", rawWinningsLo); // DEBUG

                    if (parsedBets.lo.length > 0) {
                        resultsHtml += `<div class="result-item">
                                            <span class="result-label">Lô:</span>
                                            <span class="result-value-pair">
                                                <span class="result-bet-display">${Math.round(betPointsLo).toLocaleString('vi-VN')}</span> / 
                                                <span class="result-winnings-display">${Math.round(rawWinningsLo).toLocaleString('vi-VN')}</span>
                                            </span>
                                        </div>`;
                    }
                    overallTotalWinnings += winningsLo;
                    overallTotalCostGoc += costLoGoc;

                    // --- Tính toán và hiển thị kết quả cho 3 Càng ---
                    const winnings3Cang = calculate3CangWinnings(parsedBets.bacang, specialPrizeLast3, specialPrizeLast2, baCangPayoutRate, apMaPayoutRate); 
                    const cost3CangGoc = calculate3CangCost(parsedBets.bacang, baCangCostPercentage);
                    const betAmount3Cang = calculate3CangBetAmount(parsedBets.bacang); // Tiền cược ban đầu (user nhập)
                    console.log("3Cang - Winnings:", winnings3Cang, "Cost Goc:", cost3CangGoc, "Bet Amount:", betAmount3Cang); // DEBUG

                    if (parsedBets.bacang.length > 0) {
                        resultsHtml += `<div class="result-item">
                                            <span class="result-label">3 Càng:</span>
                                            <span class="result-value-pair">
                                                <span class="result-bet-display">${Math.round(betAmount3Cang).toLocaleString('vi-VN')}</span> / 
                                                <span class="result-winnings-display">${Math.round(winnings3Cang).toLocaleString('vi-VN')}</span>
                                            </span>
                                        </div>`;
                    }
                    overallTotalWinnings += winnings3Cang;
                    overallTotalCostGoc += cost3CangGoc;

                    // --- Tính toán và hiển thị kết quả cho Xiên 2 ---
                    const winningsXien2 = calculateXienWinnings(parsedBets.xien2, allPrizesAsNumbers, 2, xien2PayoutRate); 
                    const costXien2Goc = calculateXienCost(parsedBets.xien2, xienCostPercentage);
                    const betAmountXien2 = calculateXienBetAmount(parsedBets.xien2); // Tiền cược ban đầu (user nhập)
                    console.log("Xien2 - Winnings:", winningsXien2, "Cost Goc:", costXien2Goc, "Bet Amount:", betAmountXien2); // DEBUG

                    if (parsedBets.xien2.length > 0) {
                        resultsHtml += `<div class="result-item">
                                            <span class="result-label">Xiên 2:</span>
                                            <span class="result-value-pair">
                                                <span class="result-bet-display">${Math.round(betAmountXien2).toLocaleString('vi-VN')}</span> / 
                                                <span class="result-winnings-display">${Math.round(winningsXien2).toLocaleString('vi-VN')}</span>
                                            </span>
                                        </div>`;
                    }
                    overallTotalWinnings += winningsXien2;
                    overallTotalCostGoc += costXien2Goc;

                    // --- Tính toán và hiển thị kết quả cho Xiên 3 ---
                    const winningsXien3 = calculateXienWinnings(parsedBets.xien3, allPrizesAsNumbers, 3, xien3PayoutRate); 
                    const costXien3Goc = calculateXienCost(parsedBets.xien3, xienCostPercentage);
                    const betAmountXien3 = calculateXienBetAmount(parsedBets.xien3); // Tiền cược ban đầu (user nhập)
                    console.log("Xien3 - Winnings:", winningsXien3, "Cost Goc:", costXien3Goc, "Bet Amount:", betAmountXien3); // DEBUG

                    if (parsedBets.xien3.length > 0) {
                        resultsHtml += `<div class="result-item">
                                            <span class="result-label">Xiên 3:</span>
                                            <span class="result-value-pair">
                                                <span class="result-bet-display">${Math.round(betAmountXien3).toLocaleString('vi-VN')}</span> / 
                                                <span class="result-winnings-display">${Math.round(winningsXien3).toLocaleString('vi-VN')}</span>
                                            </span>
                                        </div>`;
                    }
                    overallTotalWinnings += winningsXien3;
                    overallTotalCostGoc += costXien3Goc;

                    // --- Tính toán và hiển thị kết quả cho Xiên 4 ---
                    const winningsXien4 = calculateXienWinnings(parsedBets.xien4, allPrizesAsNumbers, 4, xien4PayoutRate); 
                    const costXien4Goc = calculateXienCost(parsedBets.xien4, xienCostPercentage);
                    const betAmountXien4 = calculateXienBetAmount(parsedBets.xien4); // Tiền cược ban đầu (user nhập)
                    console.log("Xien4 - Winnings:", winningsXien4, "Cost Goc:", costXien4Goc, "Bet Amount:", betAmountXien4); // DEBUG

                    if (parsedBets.xien4.length > 0) {
                        resultsHtml += `<div class="result-item">
                                            <span class="result-label">Xiên 4:</span>
                                            <span class="result-value-pair">
                                                <span class="result-bet-display">${Math.round(betAmountXien4).toLocaleString('vi-VN')}</span> / 
                                                <span class="result-winnings-display">${Math.round(winningsXien4).toLocaleString('vi-VN')}</span>
                                            </span>
                                        </div>`;
                    }
                    overallTotalWinnings += winningsXien4;
                    overallTotalCostGoc += costXien4Goc;

                    // Hiển thị kết quả chi tiết
                    resultDetailsDiv.innerHTML = resultsHtml;
                    console.log("Results HTML updated."); // DEBUG
                    
                    // Tính toán lời/lỗ và hiển thị
                    const netResult = overallTotalWinnings - overallTotalCostGoc;
                    let summaryMessage = '';
                    let summaryClass = '';

                    // Format the final net result in thousands with appropriate decimals
                    const formattedNetResult = formatMoneyInThousandsDisplay(netResult);

                    if (netResult > 0) {
                        summaryMessage = `Lấy về: ${formattedNetResult}`;
                        summaryClass = 'summary-profit';
                    } else if (netResult < 0) {
                        summaryMessage = `Số tiền còn phải nộp: ${formatMoneyInThousandsDisplay(Math.abs(netResult))}`;
                        summaryClass = 'summary-loss';
                    } else {
                        summaryMessage = `Hòa vốn: ${formattedNetResult}`;
                        summaryClass = 'summary-breakeven';
                    }

                    totalSummaryDiv.innerHTML = `Tổng: <span class="result-cost-display">${formatMoneyInThousandsDisplay(overallTotalCostGoc)}</span> - <span class="result-winnings-display">${formatMoneyInThousandsDisplay(overallTotalWinnings)}</span> = <span class="${summaryClass}">${summaryMessage}</span>`;
                    resultsDiv.classList.remove('hidden'); // Make sure results div is visible
                    console.log("Overall summary updated and results div shown."); // DEBUG
                } catch (error) {
                    console.error("Lỗi trong quá trình tính toán:", error); // DEBUG: Log full error
                    showMessage('Lỗi Tính Toán', `Đã xảy ra lỗi trong quá trình tính toán. Chi tiết: ${error.message}. Vui lòng kiểm tra lại dữ liệu nhập. (Xem console để biết thêm chi tiết)`);
                }
            });
        });
    </script>
</body>
</html>
